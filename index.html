<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>PDV Bitcoin → USDT Moderno</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Inter', sans-serif; background: #f4f6f8; color: #333; }
  .container { max-width: 700px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 30px; }
  h1, h2 { text-align: center; color: #222; margin-bottom: 20px; }
  input, select, button { padding: 12px; margin: 8px 0; width: 100%; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; }
  button { background: #4caf50; color: #fff; border: none; cursor: pointer; transition: 0.3s; }
  button:hover { background: #45a049; }
  .qr-container { text-align: center; margin: 20px 0; }
  img { width: 250px; height: 250px; border-radius: 12px; border: 1px solid #ddd; padding: 8px; background: #fff; }
  #status { text-align: center; margin-top: 15px; font-weight: 600; font-size: 18px; }
  #usdtReceived { text-align: center; margin-top: 5px; color: #4caf50; font-weight: 600; }
  table { width: 100%; margin-top: 25px; border-collapse: collapse; font-size: 14px; }
  th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
  th { background: #f1f3f6; font-weight: 600; }
  @media(max-width: 600px) {
    .container { padding: 20px; }
    img { width: 200px; height: 200px; }
  }
</style>
</head>
<body>
<div class="container">
  <h1>PDV Bitcoin → USDT</h1>
  <h2>Demo Moderno</h2>

  <input type="number" id="amountUSD" placeholder="Valor em USD">
  <select id="usdtNetwork">
    <option value="TRC20">USDT TRC20</option>
    <option value="ERC20">USDT ERC20</option>
  </select>
  <button id="createPayment">Gerar QR Code</button>

  <div class="qr-container">
    <img id="qrcode" src="" alt="QR Code">
  </div>

  <div id="status"></div>
  <div id="usdtReceived"></div>

  <h2>Histórico de Pagamentos</h2>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>USD</th>
        <th>BTC</th>
        <th>Rede USDT</th>
        <th>Status</th>
        <th>USDT Recebido</th>
      </tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
const historyKey = 'pdvBitcoinModernHistory';
let payments = JSON.parse(localStorage.getItem(historyKey) || '[]');

function saveHistory() {
    localStorage.setItem(historyKey, JSON.stringify(payments));
    renderHistory();
}

function renderHistory() {
    const tbody = document.getElementById('historyBody');
    tbody.innerHTML = '';
    payments.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.amountUSD}</td>
          <td>${p.amountBTC}</td>
          <td>${p.usdtNetwork}</td>
          <td>${p.status}</td>
          <td>${p.usdtReceived}</td>
        `;
        tbody.appendChild(tr);
    });
}

async function getBTCPriceUSD() {
    try {
        const resp = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
        const data = await resp.json();
        return data.bitcoin.usd;
    } catch {
        return 30000; // fallback
    }
}

document.getElementById('createPayment').addEventListener('click', async () => {
    const amountUSD = parseFloat(document.getElementById('amountUSD').value);
    const usdtNetwork = document.getElementById('usdtNetwork').value;
    if (!amountUSD) return alert('Digite um valor válido');

    const btcPrice = await getBTCPriceUSD();
    const amountBTC = (amountUSD / btcPrice).toFixed(8);

    const id = Date.now().toString();
    const btcAddress = 'bc1qexampleaddress0000000000000000000';
    const paymentURI = `bitcoin:${btcAddress}?amount=${amountBTC}`;

    QRCode.toDataURL(paymentURI, { width: 250 }, function(err, url) {
        document.getElementById('qrcode').src = url;
    });

    document.getElementById('status').textContent = 'Aguardando pagamento...';
    document.getElementById('usdtReceived').textContent = '';

    const payment = { id, amountUSD, amountBTC, usdtNetwork, status: 'pending', usdtReceived: 0 };
    payments.push(payment);
    saveHistory();

    // Simula pagamento e swap após 5s
    setTimeout(() => {
        payment.status = 'confirmed';
        payment.usdtReceived = amountUSD;
        saveHistory();
        document.getElementById('status').textContent = 'Pagamento confirmado!';
        document.getElementById('usdtReceived').textContent = `Recebido ~${payment.usdtReceived} ${usdtNetwork}`;
    }, 5000);
});

// Renderiza histórico ao carregar
renderHistory();
</script>
</body>
</html>
